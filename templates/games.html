{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Record New Game</h5>
            </div>
            <div class="card-body">
                <form id="game-form" hx-post="/api/games" hx-target="#game-message">
                    <div class="mb-3">
                        <label for="gameType" class="form-label">Game Type</label>
                        <select class="form-select" id="gameType" name="game_type" required hx-get="/api/game-form" hx-target="#team-selection" hx-trigger="change">
                            <option value="">Select game type</option>
                            <option value="1v1">1 vs 1</option>
                            <option value="2v2">2 vs 2</option>
                            <option value="2v1">2 vs 1</option>
                        </select>
                    </div>

                    <div id="team-selection">
                        <!-- Dynamic team selection will be loaded here -->
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="startTime" class="form-label">Start Time</label>
                                <input type="datetime-local" class="form-control" id="startTime" name="start_time" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="endTime" class="form-label">End Time (Optional)</label>
                                <input type="datetime-local" class="form-control" id="endTime" name="end_time">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="team1Score" class="form-label">Black Side Score</label>
                                <div class="input-group input-group-lg">
                                    <input type="number" class="form-control text-center" id="team1Score" name="team1_score" min="0" max="11" value="0" required>
                                    <button class="btn btn-outline-danger score-btn" type="button" onclick="decrementScore('team1Score')">‚àí</button>
                                    <button class="btn btn-outline-success score-btn" type="button" onclick="incrementScore('team1Score')">+</button>
                                    <button class="btn btn-outline-primary score-btn" type="button" onclick="incrementScoreBy('team1Score', 10)">+10</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="team2Score" class="form-label">White Side Score</label>
                                <div class="input-group input-group-lg">
                                    <input type="number" class="form-control text-center" id="team2Score" name="team2_score" min="0" max="11" value="0" required>
                                    <button class="btn btn-outline-danger score-btn" type="button" onclick="decrementScore('team2Score')">‚àí</button>
                                    <button class="btn btn-outline-success score-btn" type="button" onclick="incrementScore('team2Score')">+</button>
                                    <button class="btn btn-outline-primary score-btn" type="button" onclick="incrementScoreBy('team2Score', 10)">+10</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success">Record Game</button>
                </form>
                <div id="game-message" class="mt-3"></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Game Rules</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li><strong>üèÜ Scoring:</strong> Games are played to 10 points</li>
                    <li><strong>üß§ Goalkeeper Goals:</strong> Count as 2 points</li>
                    <li><strong>üî¢ 11-Point Exception:</strong> The only way to reach 11 points is with a goalkeeper goal at 9 points</li>
                    <li><strong>üéÇ Cake Rule:</strong> A 10-point difference (10-0 or 11-1) earns the winner a cake!</li>
                    <li><strong>‚è±Ô∏è Duration:</strong> Track start/end times for statistics</li>
                    <li><strong>üéÆ Game Types:</strong> 1v1, 2v2, or 2v1 matches</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Recent Games</h5>
            </div>
            <div class="card-body" id="games-history" hx-get="/api/games" hx-trigger="load, htmx:afterRequest from:#game-form">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function setCurrentTime() {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    const isoString = now.toISOString().slice(0, 16);
    document.getElementById('startTime').value = isoString;
    document.getElementById('endTime').value = isoString;
}

function incrementScore(inputId) {
    const input = document.getElementById(inputId);
    const currentValue = parseInt(input.value) || 0;
    const maxValue = parseInt(input.max) || 11;
    if (currentValue < maxValue) {
        input.value = currentValue + 1;
    }
}

function decrementScore(inputId) {
    const input = document.getElementById(inputId);
    const currentValue = parseInt(input.value) || 0;
    const minValue = parseInt(input.min) || 0;
    if (currentValue > minValue) {
        input.value = currentValue - 1;
    }
}

function incrementScoreBy(inputId, amount) {
    const input = document.getElementById(inputId);
    const currentValue = parseInt(input.value) || 0;
    const maxValue = parseInt(input.max) || 11;
    const newValue = currentValue + amount;
    input.value = Math.min(newValue, maxValue);
}

document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.xhr.status === 201 && evt.target.id === 'game-form') {
        evt.target.reset();
        document.getElementById('team-selection').innerHTML = '';
        // Reset times to current time after form reset
        setCurrentTime();
        // Reset scores to 0
        document.getElementById('team1Score').value = 0;
        document.getElementById('team2Score').value = 0;
    }
});

// Set default times to now on page load
document.addEventListener('DOMContentLoaded', function() {
    setCurrentTime();
});
</script>
{% endblock %}