{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üèÜ Leaderboard</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="minGamesToggle"
                           hx-get="/api/leaderboard"
                           hx-target="#leaderboard-content"
                           hx-include="this"
                           hx-vals='js:{"min_games": document.getElementById("minGamesToggle").checked ? 5 : 0}'>
                    <label class="form-check-label" for="minGamesToggle">
                        5+ games only
                    </label>
                </div>
            </div>
            <div class="card-body" id="leaderboard-content" hx-get="/api/leaderboard" hx-trigger="load" hx-vals='js:{"min_games": getMinGamesFilter()}'>
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>üìà Position History</h5>
            </div>
            <div class="card-body">
                <canvas id="positionChart" style="max-height: 400px;"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>üéÇ Cake Leaderboard</h5>
            </div>
            <div class="card-body" id="cake-leaderboard" hx-get="/api/cake-leaderboard" hx-trigger="load">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>üìä Win Rates by Game Type</h5>
            </div>
            <div class="card-body" id="win-rates" hx-get="/api/win-rates" hx-trigger="load">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // localStorage key for the min games filter setting
    const MIN_GAMES_STORAGE_KEY = 'leaderboard_min_games_filter';

    // Function to get the min games filter value from localStorage
    function getMinGamesFilter() {
        const stored = localStorage.getItem(MIN_GAMES_STORAGE_KEY);
        // Default to true (5 games minimum) if not set
        return stored === null ? 5 : (stored === 'true' ? 5 : 0);
    }

    // Initialize the toggle state from localStorage on page load
    document.addEventListener('DOMContentLoaded', function() {
        const toggle = document.getElementById('minGamesToggle');
        const stored = localStorage.getItem(MIN_GAMES_STORAGE_KEY);
        // Default to checked (true) if not set
        toggle.checked = stored === null ? true : stored === 'true';

        // Save to localStorage when toggle changes and reload chart
        toggle.addEventListener('change', function() {
            localStorage.setItem(MIN_GAMES_STORAGE_KEY, this.checked);
            loadPositionChart();
        });
    });

    // Initialize tooltips when content is loaded dynamically via htmx
    document.body.addEventListener('htmx:afterSwap', function(event) {
        // Initialize Bootstrap tooltips for any new content
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });

    // Plugin to draw labels at the end of each line
    const endLabelsPlugin = {
        id: 'endLabels',
        afterDatasetsDraw(chart) {
            const ctx = chart.ctx;
            chart.data.datasets.forEach((dataset, datasetIndex) => {
                const meta = chart.getDatasetMeta(datasetIndex);
                if (!meta.hidden && dataset.data.length > 0) {
                    // Find the last non-null point
                    let lastPoint = null;
                    let lastValue = null;
                    for (let i = dataset.data.length - 1; i >= 0; i--) {
                        if (dataset.data[i] !== null) {
                            lastPoint = meta.data[i];
                            lastValue = dataset.data[i];
                            break;
                        }
                    }

                    if (lastPoint) {
                        ctx.save();
                        ctx.fillStyle = dataset.borderColor;
                        ctx.font = 'bold 12px sans-serif';
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'middle';

                        const x = lastPoint.x + 8;
                        const y = lastPoint.y;
                        const label = dataset.label;

                        // Draw text with white outline for better readability
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 3;
                        ctx.strokeText(label, x, y);
                        ctx.fillText(label, x, y);

                        ctx.restore();
                    }
                }
            });
        }
    };

    // Store chart instance globally so we can destroy it before redrawing
    let positionChartInstance = null;

    // Function to load and render position chart
    function loadPositionChart() {
        const minGames = getMinGamesFilter();

        // Destroy existing chart if it exists
        if (positionChartInstance) {
            positionChartInstance.destroy();
        }

        fetch(`/api/leaderboard-position-chart?min_games=${minGames}`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('positionChart').getContext('2d');
                positionChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    layout: {
                        padding: {
                            right: 100  // Add padding for labels
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Leaderboard Position Over Time'
                        },
                        legend: {
                            display: false  // Hide legend since we have inline labels
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    return context.dataset.label + ': Rank #' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            reverse: true,  // Rank 1 at top
                            beginAtZero: false,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return '#' + value;
                                }
                            },
                            title: {
                                display: true,
                                text: 'Rank'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                },
                    plugins: [endLabelsPlugin]
                });
            })
            .catch(error => {
                console.error('Error loading position chart:', error);
                document.getElementById('positionChart').parentElement.innerHTML =
                    '<p class="text-muted text-center">No position history data available yet. Play some games to see your position history!</p>';
            });
    }

    // Load chart on page load
    loadPositionChart();
</script>
{% endblock %}